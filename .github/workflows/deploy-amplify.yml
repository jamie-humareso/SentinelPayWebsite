name: Deploy to AWS Amplify

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

env:
  AWS_REGION: us-east-2
  AMPLIFY_APP_NAME: sentinel-web

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Build application
      run: npm run build

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: us-east-2

    - name: Deploy to Amplify
      run: |
        echo "Starting deployment to Amplify..."
        
        # Get the app details
        echo "Searching for app: ${{ env.AMPLIFY_APP_NAME }}"
        APPS_JSON=$(aws amplify list-apps --region us-east-2 --output json)
        APP_ID=$(echo "$APPS_JSON" | jq -r ".apps[] | select(.name == \"${{ env.AMPLIFY_APP_NAME }}\") | .appId" | head -1)
        
        echo "Found app ID: $APP_ID"
        
        if [ -z "$APP_ID" ] || [ "$APP_ID" = "null" ]; then
          echo "Error: App '${{ env.AMPLIFY_APP_NAME }}' not found!"
          exit 1
        fi
        
        # Check if the app is connected to a repository
        echo "Checking app configuration..."
        APP_CONFIG=$(aws amplify get-app --app-id $APP_ID --region us-east-2 --output json)
        REPO_URL=$(echo "$APP_CONFIG" | jq -r '.app.repository')
        
        if [ "$REPO_URL" = "null" ] || [ -z "$REPO_URL" ]; then
          echo "App is not connected to a repository. Connecting to GitHub..."
          
          # Connect the app to the GitHub repository
          aws amplify create-webhook \
            --app-id $APP_ID \
            --branch-name main \
            --region us-east-2 \
            --description "GitHub webhook for automatic deployments"
          
          echo "Webhook created. App is now connected to GitHub repository."
          echo "Future pushes to main branch will trigger automatic deployments."
        else
          echo "App is already connected to repository: $REPO_URL"
        fi
        
        # Trigger a manual build
        echo "Triggering manual build..."
        aws amplify start-job \
          --app-id $APP_ID \
          --branch-name main \
          --job-type RELEASE \
          --region us-east-2
        
        echo "Deployment initiated successfully!"
        echo "App ID: $APP_ID"
        echo "Branch: main"
        echo "Check AWS Amplify console for build status"

    - name: Deploy status
      run: |
        echo "Deployment initiated successfully!"
        echo "Check AWS Amplify console for deployment status"
        echo "Your site will be available at: https://${{ env.AMPLIFY_APP_NAME }}.amplifyapp.com"
